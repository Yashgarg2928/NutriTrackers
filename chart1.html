<!DOCTYPE html >
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sustainable Food Tracker â€” Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 24px; color:#111 }
    header { display:flex; align-items:center; gap:16px; margin-bottom:18px; }
    header h1 { margin:0; font-size:20px; }
    .controls { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    input[type="text"] { padding:8px; font-size:14px; width:300px; border-radius:6px; border:1px solid #ddd; }
    button { padding:8px 12px; font-size:14px; border-radius:8px; border:0; background:#1070ff; color:white; cursor:pointer; }
    button.secondary { background:#eee; color:#111; }
    .card { border:1px solid #e6e6e6; border-radius:8px; padding:12px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); margin-bottom:12px; }
    .row { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .col { flex:1 1 280px; min-width:260px; }
    img.product-img { width:120px; height:120px; object-fit:cover; border-radius:8px; border:1px solid #eee; }
    .small { font-size:13px; color:#444 }
    .badge { display:inline-block; padding:6px 8px; border-radius:6px; font-weight:600; }
    .ecoscore { background:#f0f6ff; color:#0b4db1 }
    .healthgrade { background:#fff7e6; color:#b35a00 }
    ul { padding-left:18px; margin:6px 0; }
    .alternatives li { margin-bottom:8px; }
    .eco-points { font-size:22px; font-weight:700; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸŒ± Sustainable Food Tracker</h1>
    <div class="small">Scan barcode or search by product name</div>
  </header>

  <div class="controls card">
    <input id="queryInput" type="text" placeholder="Enter barcode (e.g. 737628064502) or product name (e.g. 'coca cola')" />
    <button id="fetchBtn">Lookup</button>
    <button id="randomBtn" class="secondary">Random sample</button>
    <button id="earnBtn" class="secondary">Claim eco-points</button>
    <div style="margin-top:8px;" class="small">Tip: for barcode lookup use numeric barcode. For fuzzy lookup use product name.</div>
  </div>

  <div id="result" class="card" style="display:none;">
    <div class="row">
      <div class="col" style="display:flex; gap:12px; align-items:center;">
        <div>
          <img id="productImage" class="product-img" src="" alt="product image" />
        </div>
        <div>
          <h2 id="productName" style="margin:0 0 6px 0;"></h2>
          <div id="brands" class="small"></div>
          <div style="margin-top:8px;">
            <span id="ecoscoreBadge" class="badge ecoscore"></span>
            <span id="healthBadge" class="badge healthgrade" style="margin-left:8px"></span>
          </div>
          <div style="margin-top:8px;" class="small">COâ‚‚ est: <span id="co2Est">â€”</span> kg COâ‚‚ eq / 100g</div>
          <div style="margin-top:6px;" class="small">Additives: <span id="additives">â€”</span></div>
        </div>
      </div>

      <div class="col">
        <canvas id="nutritionChart" width="400" height="300"></canvas>
      </div>
    </div>

    <hr />

    <div class="row">
      <div class="col">
        <h3 style="margin-top:0">Nutrition facts (per 100g)</h3>
        <div id="nutriments" class="small"></div>
      </div>

      <div class="col">
        <h3 style="margin-top:0">Alternatives & suggestions</h3>
        <div id="alternativeList" class="small alternatives"></div>
      </div>
    </div>

    <hr />

    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div class="small">Your eco-points balance</div>
        <div class="eco-points" id="ecoPoints">0</div>
        <div class="small">Earn points by choosing lower COâ‚‚ or better nutrition grade</div>
      </div>
      <div>
        <button id="compareBtn" class="secondary">Compare with best alt</button>
      </div>
    </div>
  </div>

  <script>

  const queryInput = document.getElementById('queryInput');
  const fetchBtn = document.getElementById('fetchBtn');
  const randomBtn = document.getElementById('randomBtn');
  const resultCard = document.getElementById('result');
  const productImage = document.getElementById('productImage');
  const productName = document.getElementById('productName');
  const brandsEl = document.getElementById('brands');
  const ecoscoreBadge = document.getElementById('ecoscoreBadge');
  const healthBadge = document.getElementById('healthBadge');
  const additivesEl = document.getElementById('additives');
  const nutrimentsEl = document.getElementById('nutriments');
  const co2El = document.getElementById('co2Est');
  const alternativesEl = document.getElementById('alternativeList');
  const ecoPointsEl = document.getElementById('ecoPoints');
  const earnBtn = document.getElementById('earnBtn');
  const compareBtn = document.getElementById('compareBtn');

  let nutritionChart = null;
  let currentProduct = null;
  let ecoPoints = Number(localStorage.getItem('eco_points') || 0);
  ecoPointsEl.textContent = ecoPoints;

  function drawNutritionChart(nutrients) {
    const ctx = document.getElementById('nutritionChart');
    const data = {
      labels: ['Fat (g)', 'Carbs (g)', 'Sugars (g)', 'Proteins (g)'],
      datasets: [{
        data: [
          nutrients.fat || 0,
          nutrients.carbohydrates || 0,
          nutrients.sugars || 0,
          nutrients.proteins || 0
        ],
      }]
    };
    if (nutritionChart) {
      nutritionChart.data = data;
      nutritionChart.update();
    } else {
      nutritionChart = new Chart(ctx, {
        type: 'pie',
        data,
        options: {
          plugins: {
            title: { display: true, text: 'Nutrition breakdown (per 100g)' },
            legend: { position: 'bottom' }
          }
        }
      });
    }
  }

  function tryExtractCO2(product) {
    try {
      if (product.ecoscore_data && product.ecoscore_data.agribalyse && product.ecoscore_data.agribalyse.co2) {
        return Number(product.ecoscore_data.agribalyse.co2);
      }
      if (product.agribalyse && product.agribalyse.co2) {
        return Number(product.agribalyse.co2);
      }
      if (product.co2_100g) {
        return Number(product.co2_100g);
      }
    } catch (e) {}
    return null;
  }

  function estimateCO2Heuristic(product) {
    const categories = (product.categories || '').toLowerCase();
    const ingredients = ((product.ingredients_text || '')).toLowerCase();
    if (categories.includes('cheese') || categories.includes('milk') || categories.includes('yogurt') || categories.includes('dairy') || ingredients.includes('milk')) {
      return 1.2;
    }
    if (categories.includes('meat') || categories.includes('sausage') || categories.includes('chicken') || categories.includes('beef') || ingredients.includes('meat')) {
      return 2.5;
    }
    if (categories.includes('fish') || ingredients.includes('fish')) {
      return 1.5;
    }
    if (categories.includes('chocolate') || categories.includes('cocoa')) {
      return 1.0;
    }
    if (categories.includes('vegetable') || categories.includes('fruit') || categories.includes('vegetables')) {
      return 0.05;
    }

    const n = product.nutriments || {};
    const proteins = Number(n.proteins_100g || 0);
    const fat = Number(n.fat_100g || 0);
    const est = 0.08 + proteins * 0.02 + fat * 0.03;
    return Number(est.toFixed(2));
  }

  async function fetchProductByBarcode(barcode) {
    const url = `https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(barcode)}.json`;
    const res = await fetch(url);
    const json = await res.json();
    if (json.status === 1) return json.product;
    else throw new Error('Product not found by barcode.');
  }

  async function searchProductByName(name, page_size = 12) {
    const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(name)}&search_simple=1&action=process&json=1&page_size=${page_size}`;
    const res = await fetch(url);
    const json = await res.json();
    return json.products || [];
  }

  function renderProduct(product) {
    currentProduct = product;
    resultCard.style.display = 'block';
    productImage.src = product.image_small_url || product.image_front_small_url || '';
    productName.textContent = product.product_name || product.generic_name || 'Unnamed product';
    brandsEl.textContent = product.brands || '';
    ecoscoreBadge.textContent = product.ecoscore_grade ? `Eco: ${product.ecoscore_grade.toUpperCase()}` : 'Eco: â€”';
    healthBadge.textContent = product.nutrition_grade_fr ? `Health: ${product.nutrition_grade_fr.toUpperCase()}` : (product.nutrition_grades ? `Health: ${product.nutrition_grades.toUpperCase()}` : 'Health: â€”');

    const additives = product.additives_tags && product.additives_tags.length ? product.additives_tags.map(t => t.replace('en:', '')).join(', ') : 'None / unknown';
    additivesEl.textContent = additives;

    const n = product.nutriments || {};

    
    const nutrHTML = `
<table style="width:100%; border-collapse:collapse; font-size:13px;">
  <tr>
    <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Nutrient</th>
    <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Amount (per 100g)</th>
  </tr>

  <tr><td style="padding:6px;">Energy</td><td style="padding:6px;">${n['energy-kcal_100g'] ?? n.energy_100g ?? 'â€”'} kcal</td></tr>
  <tr><td style="padding:6px;">Fat</td><td style="padding:6px;">${n.fat_100g ?? 'â€”'} g</td></tr>
  <tr><td style="padding:6px;">Saturated Fat</td><td style="padding:6px;">${n['saturated-fat_100g'] ?? 'â€”'} g</td></tr>
  <tr><td style="padding:6px;">Carbs</td><td style="padding:6px;">${n.carbohydrates_100g ?? 'â€”'} g</td></tr>
  <tr><td style="padding:6px;">Sugars</td><td style="padding:6px;">${n.sugars_100g ?? 'â€”'} g</td></tr>
  <tr><td style="padding:6px;">Proteins</td><td style="padding:6px;">${n.proteins_100g ?? 'â€”'} g</td></tr>
  <tr><td style="padding:6px;">Salt</td><td style="padding:6px;">${n.salt_100g ?? 'â€”'} g</td></tr>
</table>
`;
    nutrimentsEl.innerHTML = nutrHTML;

    const nutrientsForChart = {
      fat: Number(n.fat_100g || 0),
      carbohydrates: Number(n.carbohydrates_100g || 0),
      sugars: Number(n.sugars_100g || 0),
      proteins: Number(n.proteins_100g || 0),
    };
    drawNutritionChart(nutrientsForChart);

    let co2 = tryExtractCO2(product);
    if (co2 == null) co2 = estimateCO2Heuristic(product);
    co2El.textContent = `${co2}`;

    findAlternatives(product);
  }

  async function findAlternatives(product) {
    alternativesEl.innerHTML = 'Searching for alternatives...';
    const name = product.product_name || product.generic_name || product.brands || '';
    if (!name) { alternativesEl.innerHTML = 'No suggestions'; return; }

    const searchTerm = (product.categories || '').split(',')[0] || name.split(' ')[0];

    try {
      const candidates = await searchProductByName(searchTerm, 30);
      const scored = candidates
        .filter(p => p.product_name && p.ecoscore_score != null)
        .map(p => ({
          p,
          eco: Number(p.ecoscore_score),
          health: p.nutrition_grade_fr || p.nutrition_grades || 'z'
        }))
        .sort((a, b) => (b.eco - a.eco) || a.health.localeCompare(b.health))
        .slice(0,6);

      if (scored.length === 0) {
        alternativesEl.innerHTML = '<div class="small">No better alternatives found.</div>';
        return;
      }

      alternativesEl.innerHTML = '';
      scored.forEach(item => {
        const alt = item.p;
        const altCo2 = tryExtractCO2(alt) ?? estimateCO2Heuristic(alt);
        const div = document.createElement('div');
        div.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center;">
            <img src="${alt.image_small_url || alt.image_front_small_url || ''}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #eee;" />
            <div style="flex:1;">
              <strong>${alt.product_name}</strong><br/>
              <span style="color:#555; font-size:13px;">Eco: ${alt.ecoscore_grade?.toUpperCase() || 'â€”'} â€¢ Health: ${alt.nutrition_grade_fr || 'â€”'}</span>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:700">${altCo2} kg</div>
              <div style="font-size:12px;color:#666">COâ‚‚ /100g</div>
            </div>
          </div>
        `;
        alternativesEl.appendChild(div);
      });

      resultCard.dataset.bestAlt = JSON.stringify(scored[0].p);
    } catch (e) {
      alternativesEl.innerHTML = `<div class="small">Error: ${e.message}</div>`;
    }
  }

  fetchBtn.addEventListener('click', async () => {
    const q = queryInput.value.trim();
    if (!q) { alert('Enter a barcode or product name'); return; }
    await performLookup(q);
  });

  randomBtn.addEventListener('click', async () => {
    const samples = ['737628064502','5000159484695','5449000000996','3017620422003','7622210449283'];
    const bc = samples[Math.floor(Math.random()*samples.length)];
    queryInput.value = bc;
    await performLookup(bc);
  });

  async function performLookup(q) {
    try {
      if (/^\d{6,}$/.test(q)) {
        const product = await fetchProductByBarcode(q);
        renderProduct(product);
      } else {
        const results = await searchProductByName(q, 10);
        if (!results.length) { alert('No results found'); return; }

        const product = results[0];
        if (product.code) {
          try {
            const full = await fetchProductByBarcode(product.code);
            renderProduct(full);
          } catch {
            renderProduct(product);
          }
        } else {
          renderProduct(product);
        }
      }
    } catch (err) {
      alert('Lookup failed: ' + err.message);
    }
  }

  earnBtn.addEventListener('click', () => {
    if (!currentProduct) { alert('Lookup a product first'); return; }
    let points = 5;
    const co2 = tryExtractCO2(currentProduct) ?? estimateCO2Heuristic(currentProduct);

    if (co2 < 0.1) points += 20;
    else if (co2 < 0.5) points += 10;
    else if (co2 < 1.0) points += 6;
    else points += 2;

    const grade = (currentProduct.nutrition_grade_fr || currentProduct.nutrition_grades || 'z').toLowerCase();
    if (grade === 'a') points += 10;
    else if (grade === 'b') points += 6;
    else if (grade === 'c') points += 2;

    ecoPoints += points;
    localStorage.setItem('eco_points', ecoPoints);
    ecoPointsEl.textContent = ecoPoints;
    alert(`You earned ${points} eco-points!`);
  });

  compareBtn.addEventListener('click', () => {
    const bestStr = resultCard.dataset.bestAlt;
    if (!bestStr) return alert('No alternative available');

    const alt = JSON.parse(bestStr);
    const originalCO2 = tryExtractCO2(currentProduct) ?? estimateCO2Heuristic(currentProduct);
    const altCO2 = tryExtractCO2(alt) ?? estimateCO2Heuristic(alt);
    const delta = (originalCO2 - altCO2).toFixed(2);

    alert(`Best alternative: ${alt.product_name}
Original COâ‚‚: ${originalCO2} kg/100g
Alternative COâ‚‚: ${altCO2} kg/100g
COâ‚‚ saved: ${delta} kg/100g`);
  });

  </script>
</body>
</html>
